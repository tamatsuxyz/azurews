**目次**

* 演習 1: Azure にリソースを展開する
    * タスク 1: Azure Database for PostgreSQL の作成
    * タスク 2: Azure 仮想マシン の作成
    * タスク 3: リソース マネージャー テンプレートを使用した展開
    * タスク 4: Azure Database for PostgreSQL への接続

* 演習 2: 監視と管理
    * タスク 1: Azure Monitor Insights を使用した監視

* 演習 3: ネットワーク
    * タスク 1: 仮想ネットワーク間のピアリング接続
    * タスク 2: リージョン内のトラフィックを分散する
    * タスク 3: PaaS サービスをプライベート エンドポイントで保護する

* 演習 4: 可用性とスケーラビリティ
    * タスク 1: スケール アップ・スケール ダウン
    * タスク 2  Azure PostgreSQL を使用したリージョン冗長構成の実現
    * タスク 3: Azure フロント ドアを使用したリージョン冗長構成


>**学習目標**
>---
>このハンズオン ラボでは、事前構成済みの IaaS 環境を展開し、それを再設計および更新して、復元力と一般的な高可用性を考慮します。ハンズオン ラボ全体を通して、さまざまな構成オプションとサービスを使用して、回復力のあるアーキテクチャを構築します。
>
>ラボの終わりには、可用性ゾーン、SQL Server Always On 可用性グループ、Azure Site Recovery、Azure Backup、および Azure Front Door をより適切に設計および使用して、高可用性、災害対策を含む完全に回復力のある IaaS アプリケーションを実装できるようになります。リカバリ、およびデータベースと仮想マシンの両方のバックアップ。

**概要**
---
Contoso は、既存のオンプレミスのアプリケーションを Microsoft Azure に移行することを検討しています。この際、アプリケーションの変更を最小限に留めながら、できるだけマネージド サービスを取り入れることを期待してます。

今回、Azure へのマイグレーションに伴い、OS のバージョンや RDBMS のバージョンは最新化することを検討しています。


**ソリューション アーキテクチャ**
---
以下の図は、このラボで構築する復元力の高いアプリケーション アーキテクチャを示しています。WebVM1、SQLVM1、および DCVM1 だけから始めて、最初に完全に冗長な高可用性環境を米国中部に構築します。次に、この環境を米国東部 2 の災害復旧サイトに拡張し、Web 層とデータベース層の両方にバックアップ ソリューションを追加します。

東日本リージョンの展開から開始し、セカンダリ リージョンへの拡張を行います。

---
＊＊＊＊＊＊図を追加 ＊＊＊＊＊＊＊＊＊＊
---

## 演習 1: Azure にリソースを展開する
---
所要時間: 45 分

Contoso 社の業務アプリケーションは、2階層アーキテクチャであり、RDBMS 製品として PostgreSQL を使用しています。Web アプリケーションは今後 PaaS サービスを活用することを検討していますが、現時点では、既存のパッケージ製品を使用を継続することを検討しています。パッケージ製品のソフトウェア要件で、Web サーバーは Windows OS の仮想マシンを展開する必要があります。


## タスク 1: Azure Database for PostgreSQL を展開する
1. Web ブラウザで Azure ポータルを開きます。（https://portal.azure.com）

   認証画面が表示されたら、サブスクリプションの資格情報を入力して、ログインします。
2. [**＋リソースの作成**] をクリックします。
3. カテゴリから **データベース** を選択し、[**Azure Database for PostgreSQL**] をクリックします。
4. **サービスをどのように使用する予定ですか？** 画面で、**単一サーバー** の [**作成**] ボタンをクリックします。
5. **基本** タブの項目では、以下の情報を入力します。入力後、[**確認および作成**] ボタンをクリックします。
    * リソース グループ: **Prefix**-azurews (新規作成)

        ※ **Prefix** 部分は、任意の文字（ご自身のイニシャルなど）で置き換えてください

    * サーバー名: **Prefix**-psql
    * 地域: 東日本
    * 管理者ユーザー名:
    * コンピューティングとストレージ: 汎用目的

        ※ **サーバーの構成** をクリックして、以下を指定します。
        * vCore: 2
        * ストレージ 5 GB
        * ストレージの自動拡張: いいえ
    * パスワード/パスワードの確認: (**任意のパスワードを入力**)
6. [**作成**] ボタンをクリックします。
7. **デプロイが完了しました** のメッセージが出力されたら [**リソースに移動**] ボタンをクリックします。


## タスク 2: Azure 仮想マシンを作成する
このタスクでは、Web サーバーとなる Azure 仮想マシン をデプロイします。

1. [**＋リソースの作成**] をクリックします。
2. [**Windows Server 2019 Datacenter**] をクリックします。
3. **基本** タブの項目では、以下の情報を入力します。入力後、[**次: ディスク**] ボタンをクリックします。
    * リソース グループ: **Prefix**-azurews (既存）

        ※ タスク1 で作成したリソース グループ名を選択します。

    * 仮想マシン名: WebVM00
    * 地域: 東日本
    * ユーザー名:
    * パスワード/パスワードの確認: (**任意のパスワードを入力**)
4. **ディスク** タブの項目では、以下の情報を入力します。入力後、[**次: ネットワーク**] ボタンをクリックします。
    * OS のディスクの種類: Standard HDD
5. **ネットワーク** タブの項目では、以下の情報を入力します。入力後、[**確認および作成**] ボタンをクリックします。
    * 仮想ネットワーク: vnet-jpe（新規作成）
        * アドレス範囲: 10.0.0.0/**16**
        * サブネット名: web
        * アドレス空間: 10.0.0.0/**24**
6. **検証に成功しました** のメッセージが出力されたら、[**作成**] ボタンをクリックします。
7. **デプロイが完了しました** のメッセージが出力されたら [**リソースに移動**] ボタンをクリックします。

＊＊＊＊＊＊ IIS の有効化 ＊＊＊＊＊＊＊＊＊＊
```azurepowershell
 Set-AzVMExtension `
  -ResourceGroupName myResourceGroupAG `
  -ExtensionName IIS `
  -VMName myVM `
  -Publisher Microsoft.Compute `
  -ExtensionType CustomScriptExtension `
  -TypeHandlerVersion 1.4 `
  -SettingString '{"commandToExecute":"powershell Add-WindowsFeature Web-Server; powershell Add-Content -Path \"C:\\inetpub\\wwwroot\\Default.htm\" -Value $($env:computername)"}' `
  -Location EastUS
```
＊＊＊＊＊＊ IIS の有効化 ＊＊＊＊＊＊＊＊＊＊

## タスク 3: Azure Database for PostgreSQL へ接続する
このタスクでは、Web サーバーにログインして、Azure Database for PostgreSQL へ接続確認を行います。

1. [**接続**] をクリックします。
2. [**RDP ファイルのダウンロード**] ボタンをクリックします。
3. ダウンロードした RDP ファイルを開きます。
4. メッセージが表示されたら、[**接続**] をクリックし、仮想マシンの資格情報を入力してログインできることを確認します。

＊＊＊＊＊＊ psql のインストール ＊＊＊＊＊＊＊＊＊＊
＊＊＊＊＊＊ psql での接続 ＊＊＊＊＊＊＊＊＊＊
＊＊＊＊＊＊ psql でのサンプルコマンドの実行 ＊＊＊＊＊＊＊＊＊＊


## タスク 4: リソース マネージャー テンプレートを使用して複数のリソースを一括で展開する
このタスクでは、追加の Web サーバと、アプリケーション ゲートウェイを展開します。
また、後半の演習で必要となる一部のリソースも一括で展開します。

今回は、Azure の IaC (Infrastructure as a Code) ソリューションであるリソース マネージャー テンプレートを使用して作成します。

1. 以下の [**Deploy to Azure**] ボタンをクリックして、Azure ポータルを開き、Contoso アプリケーションの高可用性に必要となる、追加のインフラストラクチャを コンポーネントのテンプレート デプロイを起動します。プロンプトが表示された場合は、サブスクリプションの資格情報を使用して Azure ポータルにログインします。

2. **カスタム デプロイ**画面で、以下の情報を入力します。入力後、[**確認および作成**] ボタンをクリックします。
    * リソース グループ: **Prefix**-azurews (既存）
    * 地域: 東日本
＊＊＊＊＊＊ 具体的なテンプレートパラメーターの追加 ＊＊＊＊＊＊＊＊＊＊
3. リソースがデプロイされるのを待っている間、テンプレートの内容を確認してください。あなたは移動して、テンプレートを確認でき **Prefix**-azurews の選択、リソース・グループの展開リソースグループ内に続く、展開のいずれかを選択します。

テンプレートには、必要なさまざまなリソースを含む、以下の 5 つの子テンプレートが含まれていることに注目してください。
* 2 番目の Web サーバーとなる WebVM01（仮想マシン）
* Web サーバー用の負荷分散サービスとある AppGW（アプリケーション ゲートウェイ）
* リージョン冗長化のための負荷分散サービスである Azure フロントドア
* セカンダリ リージョン用の仮想ネットワーク
* セカンダリ リージョン用の Web サーバーとなる WebVM10（仮想マシン）


4. **Prefix**-azurews リソース グループに移動し、左側のナビゲーションの [デプロイ] を選択することで、リソースのデプロイ状態を確認できます。次のタスクに進む前に、すべてのテンプレートの展開ステータスが成功であることを確認してください。



## 演習 3: ネットワーク
---
所要時間: 30 分

## タスク 1: Web トラフィックの負荷分散を構成する


## タスク 2: Azure Database for PostgreSQL をプライベート エンドポイントで保護する
Contoso とセキュリティ要件をヒアリングしたところ、Azure Database for PostgreSQL は、特定の仮想ネットワークからのみアクセスできるように制限をする必要があることがわかりました。
Azure の提供機能としては、サービス エンドポイントかプライベート エンドポイントが要件を満たすことを特定しましたが、
更なるヒアリングを行ったところ、他の Azure Database for PostgreSQL リソースへのアクセスを禁止する必要が

Azure Database for PostgreSQL にプライベート エンドポイントを構成すること、そのサーバーを仮想ネットワーク (VNet) 内に取り入れることができます。
プライベート エンドポイントでは、VNet 内の他のリソースと同様に、データベース サーバーへの接続に使用できるサブネット内のプライベート IP が公開されます。

> [*注意*]
>
> プライベート リンク機能は、汎用またはメモリ最適化のいずれかの価格レベルの Azure Database for PostgreSQL サーバーでのみ使用可能です。

1. Azure ポータル上部の、検索欄に [Private Link] と入力し、表示された [Private Link] をクリックします。
2. [プライベート エンドポイントの作成] ボタンを選択します。
3. **基本**タブで以下の情報を入力します。入力後は、[次:リソース] をクリックします。
    * リソース グループ: **Prefix**-azurews (既存）
    * 名前: psqlPrivateEndpoint
    * リージョン: 東日本
4. **リソース**タブで、以下の情報を入力します。入力後は、[次:構成] をクリックします。
    * リソースの種類: Microsoft.DBforPostgreSQL/servers
    * リソース: **Prefix**-psql
    * ターゲット サブリソース: postgresqlServer
5. **構成**タブで以下の情報を入力します。入力後は、[**確認および作成**] をクリックします。
    * 仮想ネットワーク: vnet-jpe
    * サブネット: web ******************
    * プライベート DNS ゾーンとの統合: はい
    * プライベート DNS ゾーン: （新規）privatelink.postgres.database.azure.com
6. **検証に成功しました** と表示されたら、 [**作成**] ボタンをクリックします。
7. **デプロイが完了しました** のメッセージが出力されることを確認します。
8. WebVM01 に RDP 接続でログインします。（具体的な手順は、演習 1 - タスク3 を参照してください）
9.  ＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊ postgreSQL への接続確認手順 *********************



## 演習 4: 可用性とスケーラビリティ
---
所要時間: 45 分

## タスク 1: スケール アップ・スケール ダウン
1. プライマリ サーバーとして使用する既存の Azure Database for PostgreSQL サーバーを選択します。
2. サーバー サイドバーで、 [設定] の [レプリケーション] を選択します。


## タスク 2  Azure Database for PostgreSQL をリージョン冗長構成変更にする

1. プライマリ サーバーとして使用する既存の Azure Database for PostgreSQL サーバーを選択します。
2. サーバー サイドバーで、 [設定] の [レプリケーション] を選択します。
3. [＋レプリカの追加] を選択します。
4. 以下の情報を入力します。入力後は、[**OK**] をクリックします。
    * サーバー名: Prefix-psql2
    * 場所: 西日本



> 注意
>
> Basic レベルのサーバーは、同じリージョンのレプリケーションのみをサポートしています。

> 重要
>
> プライマリ サーバーで障害が発生した場合、読み取りレプリカに自動的にフェールオーバーされることは**ありません**。
> プライマリとレプリカの間のレプリケーションを停止することにより、レプリカが再起動され、独立したスタンドアロンの読み取りと書き込みが可能なサーバーとして昇格します。
>
> また、プライマリ サーバーと読み取りレプリカへのレプリケーションを停止した後、それを元に戻すことはできません。 読み取りレプリカは、読み取りと書き込みの両方をサポートするスタンドアロン サーバーになります。スタンドアロン サーバーをもう一度レプリカにすることはできません。



## タスク 3: Web サーバーを Azure フロント ドアでリージョン冗長構成に変更する
1. プライマリ サーバーとして使用する既存の Azure Database for PostgreSQL サーバーを選択します。
2. サーバー サイドバーで、 [設定] の [レプリケーション] を選択します。
